name: Call REST API on Commit

on:
  push:
    branches:
      - csa_release

jobs:
  call_api:
    runs-on: ubuntu-latest

    env:
      HEADERS: ${{ secrets.HEADERS }}
      TOKEN: ${{ secrets.GIT_TRIGGER_HELLO }}
      BODY: ${{ secrets.BODY }}
      URL: 'https://windmill.service.avaloq.com/api/w/laboratorium/jobs/run/p/f/locus_experimentorum/laboratory_experiment_sentiment_analysis'

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Call REST API
      run: |
        UUID=$(curl -s -H 'Content-Type: application/json' -H "Authorization: Bearer $TOKEN" -X POST -d "$BODY" $URL)
        URL="https://windmill.service.avaloq.com/api/w/laboratorium/jobs_u/completed/get_result_maybe/$UUID"
        while true; do
        RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" $URL)
        COMPLETED=$(echo $RESPONSE | jq .completed)
        if [ "$COMPLETED" = "true" ]; then
          echo $RESPONSE | jq .result
          break
        else
          sleep 1
        fi
      done
